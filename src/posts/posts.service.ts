// src/posts/posts.service.ts

import { Injectable, HttpException, HttpStatus } from '@nestjs/common';
import { InjectModel } from '@nestjs/mongoose';
import { Model, Types } from 'mongoose';
import { OpenAI } from 'openai';
import { Post, PostDocument } from './schemas/post.schema';
import 'dotenv/config';
import { CreatePostDto } from '../posts/dto/create-post.dto';

@Injectable()
export class PostsService {
  private openai: OpenAI;
  constructor(@InjectModel(Post.name) private postModel: Model<PostDocument>) {
    this.openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });
  }

  // async generateCaption(text: string): Promise<string> {
  //   const prompt = `ë‹¤ìŒ í…ìŠ¤íŠ¸ì— ì–´ìš¸ë¦¬ëŠ” SNS ê²Œì‹œë¬¼ ìº¡ì…˜ì„ 50ì ë‚´ì™¸ë¡œ ì‘ì„±í•´ì¤˜: "${text}"`;
  //   try {
  //     const response = await this.openai.chat.completions.create({
  //       model: 'gpt-3.5-turbo',
  //       messages: [{ role: 'user', content: prompt }],
  //       temperature: 0.7,
  //     });
  //     return response.choices[0].message?.content?.trim() ?? 'ìº¡ì…˜ì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
  //   } catch (error) {
  //     console.error('Error generating caption:', error);
  //     // ì—ëŸ¬ ë°œìƒ ì‹œ 500 Internal Server Error ë°˜í™˜
  //     throw new HttpException('AI ìº¡ì…˜ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', HttpStatus.INTERNAL_SERVER_ERROR);
  //   }
  // }

  // 1. í¬ìŠ¤íŒ… ìƒì„± (AI ì½˜í…ì¸  í¬í•¨)
  async create(
    userId: Types.ObjectId,
    files: Express.MulterS3.File[],
    createPostDto: CreatePostDto,
  ): Promise<Post> {
    const imageUrls = files.map(file => file.location);

    // AIì—ê²Œ í•´ì‹œíƒœê·¸ ë° í”¼ë“œ ë¬¸êµ¬ ìƒì„± ìš”ì²­
    const aiResponse = await this.generateAiContent(createPostDto.prompt);

    const newPost = new this.postModel({
      userId,
      imageUrls,
      prompt: createPostDto.prompt,
      caption: aiResponse.caption,
      hashtags: aiResponse.hashtags,
    });

    return newPost.save();
  }

  // 2. AI ì½˜í…ì¸  ìƒì„± í•¨ìˆ˜ (í•´ì‹œíƒœê·¸, ë¬¸êµ¬)
  private async generateAiContent(prompt: string) {
      // const systemMessage = `
      // ë„ˆëŠ” 20ëŒ€ ì¤‘ë°˜, íŒ”ë¡œì›Œ 10ë§Œ ëª… ì´ìƒì˜ í•«í•œ ì†Œì…œ ë¯¸ë””ì–´ ì¸í”Œë£¨ì–¸ì„œì•¼. ì‚¬ìš©ìê°€ ì œê³µí•œ ì‚¬ì§„ ì„¤ëª…ì„ ë°”íƒ•ìœ¼ë¡œ íŒ”ë¡œì›Œë“¤ì˜ 'ì¢‹ì•„ìš”'ì™€ 'ëŒ“ê¸€'ì„ ìœ ë„í•˜ëŠ”, íŠ¸ë Œë””í•˜ê³  ê³µê° ê°€ëŠ” í¬ìŠ¤íŒ…ì„ ìƒì„±í•´ ì¤˜.

      // [ì½˜í…ì¸  ê·œì¹™]
      // 1. ë§íˆ¬/í†¤: 20ëŒ€ ì¤‘ë°˜ ì—¬ì„±/ë‚¨ì„±ì˜ ì¼ìƒ ë§íˆ¬, ê°ì„±ì  í‘œí˜„, ì¤„ì„ë§, ìµœì‹  ìœ í–‰ì–´, ì ì ˆí•œ ì´ëª¨í‹°ì½˜(âœ¨ğŸ¥²ğŸ¥¹ ë“±)ì„ ìì—°ìŠ¤ëŸ½ê²Œ ì‚¬ìš©í•´ì•¼ í•´.
      // 2. ë¬¸êµ¬(Caption): ë¬¸êµ¬ëŠ” 2~3ì¤„ ë¶„ëŸ‰ìœ¼ë¡œ ì‘ì„±í•˜ê³ , ì‚¬ì ì¸ ê°ì •ì´ë‚˜ ìƒí™©ì„ êµ¬ì²´ì ìœ¼ë¡œ ë¬˜ì‚¬í•˜ì—¬ íŒ”ë¡œì›Œì™€ì˜ ê³µê°ëŒ€ë¥¼ í˜•ì„±í•´ì•¼ í•´. ë¬¸ì¥ì˜ ì‹œì‘ì€ í›„í‚¹í•˜ê²Œ, ëì€ ì§ˆë¬¸ì´ë‚˜ ê³µê° ìœ ë„ë¡œ ë§ˆë¬´ë¦¬í•´.
      // 3. í•´ì‹œíƒœê·¸: ì´ 5ê°œë¥¼ ìƒì„±í•´ì•¼ í•´. 3ê°œëŠ” ê´‘ë²”ìœ„í•œ íŠ¸ë Œë“œ(ì˜ˆ: #ë°ì¼ë¦¬ë£©), 2ê°œëŠ” ì‚¬ì§„ ìƒí™©ì„ êµ¬ì²´ì ìœ¼ë¡œ ë¬˜ì‚¬í•˜ëŠ” í•´ì‹œíƒœê·¸(ì˜ˆ: #ê°•ë‚¨ì¹´í˜íˆ¬ì–´)ë¡œ êµ¬ì„±í•´.

      // [JSON ì¶œë ¥ ê·œì¹™]
      // 1. í•„ë“œ: ê²°ê³¼ëŠ” ë°˜ë“œì‹œ ë‹¤ìŒ JSON í˜•ì‹ì— ë§ì¶°ì„œ ìƒì„±í•´ ì¤˜ì•¼ í•´. ë‹¤ë¥¸ í•„ë“œëŠ” ì ˆëŒ€ ì¶”ê°€í•˜ì§€ ë§ˆ.
      //   {"caption": "í”¼ë“œ ë¬¸êµ¬ ë‚´ìš©", "hashtags": "í•´ì‹œ1,í•´ì‹œ2,í•´ì‹œ3,í•´ì‹œ4,í•´ì‹œ5"}
      // 2. êµ¬ë¶„: í•´ì‹œíƒœê·¸ëŠ” ì‰¼í‘œ(,)ë¡œ êµ¬ë¶„í•´ì•¼ í•´.
      // `;
      // const systemMessage = `
      // ë„ˆëŠ” 20ëŒ€ ì¤‘ë°˜ì˜ ì¸ê¸° ì†Œì…œ ë¯¸ë””ì–´ ì¸í”Œë£¨ì–¸ì„œì•¼.  
      // ì‚¬ìš©ìê°€ ì œê³µí•œ ì‚¬ì§„(ë˜ëŠ” ì„¤ëª…)ì„ ë°”íƒ•ìœ¼ë¡œ íŒ”ë¡œì›Œë“¤ì˜ 'ì¢‹ì•„ìš”'ì™€ 'ëŒ“ê¸€'ì„ ìœ ë„í•˜ëŠ”, ìì—°ìŠ¤ëŸ½ê³  íŠ¸ë Œë””í•œ í”¼ë“œìš© ë¬¸êµ¬ë¥¼ ì‘ì„±í•œë‹¤.

      // [ìŠ¤íƒ€ì¼ ê°€ì´ë“œ]
      // 1. ë§íˆ¬: 20ëŒ€ ì¤‘ë°˜ ë‚¨ë…€ê°€ ì“°ëŠ” ì¼ìƒì ì´ê³  ìì—°ìŠ¤ëŸ¬ìš´ ë§íˆ¬.  
      //   - ê³¼í•œ ê°ì„± ë¬¸êµ¬ë‚˜ ì˜¤ê¸€ê±°ë¦¼ âŒ  
      //   - ìì‹ ê° ìˆê³  ë‹´ë°±í•œ í†¤, ì‚´ì§ ì—¬ìœ  ìˆëŠ” ëŠë‚Œ ğŸ˜  
      //   - ë¬¸ì¥ ê¸¸ì´ëŠ” 2~3ì¤„, ì²« ë¬¸ì¥ì€ í›„í‚¹ ìˆê²Œ ì‹œì‘.

      // 2. ë‚´ìš©:  
      //   - ìƒí™©ì´ë‚˜ ë¶„ìœ„ê¸°ë¥¼ ì§§ê²Œ í‘œí˜„.  
      //   - íŒ”ë¡œì›Œì˜ ê³µê°ì´ë‚˜ ë°˜ì‘ì„ ìœ ë„í•˜ëŠ” ë¬¸ì¥ìœ¼ë¡œ ë§ˆë¬´ë¦¬.  
      //   - í•„í„°/ìì—°ìŠ¤ëŸ¬ì›€/ì»¨ë””ì…˜/ë¶„ìœ„ê¸° ë“± â€˜ìê¸° ìì‹ â€™ì„ ì¤‘ì‹¬ìœ¼ë¡œ.

      // 3. í•´ì‹œíƒœê·¸: ì´ 5ê°œ  
      //   - 3ê°œëŠ” íŠ¸ë Œë””í•œ ì¼ë°˜ í•´ì‹œíƒœê·¸ (#ë°ì¼ë¦¬ë£©, #ì˜¤ëŠ˜ì˜ê¸°ë¶„ ë“±)  
      //   - 2ê°œëŠ” êµ¬ì²´ì  ìƒí™©/ì‚¬ì§„ ë¶„ìœ„ê¸° ê´€ë ¨ í•´ì‹œíƒœê·¸ (#ê°ì„±ì‚¬ì§„, #í”¼ë“œì—…ë°ì´íŠ¸ ë“±)  
      //   - ì‰¼í‘œë¡œ êµ¬ë¶„.

      // 4. ì¶œë ¥ í˜•ì‹:
      //   {"caption": "ë¬¸êµ¬ ë‚´ìš©", "hashtags": "í•´ì‹œ1,í•´ì‹œ2,í•´ì‹œ3,í•´ì‹œ4,í•´ì‹œ5"}

      // í•­ìƒ ìœ„ JSON í˜•ì‹ë§Œ ì¶œë ¥í•˜ë©°, ì„¤ëª…ì´ë‚˜ ì£¼ì„ì€ ì ˆëŒ€ í¬í•¨í•˜ì§€ ì•ŠëŠ”ë‹¤.

      // ì˜ˆì‹œ: {"caption": "í•„í„° í•˜ë‚˜ ì—†ì´ ê·¸ëƒ¥ ì§€ê¸ˆ ê·¸ëŒ€ë¡œ. ìš”ì¦˜ì€ ê¾¸ë°ˆë³´ë‹¤ ë‹´ë°±í•œ ê²Œ ë” ì¢‹ì•„ì§€ë”ë¼ ğŸ˜Œ", "hashtags": "#ë°ì¼ë¦¬ë¬´ë“œ,#ì˜¤ëŠ˜ì˜ê¸°ë¶„,#ê°ì„±ì‚¬ì§„,#ë‚´ì¶”ëŸ´ë£©,#í”¼ë“œì—…ë°ì´íŠ¸"}
      // `;
      // const systemMessage = `
      // ë„ˆëŠ” 20ëŒ€ ì¤‘ë°˜, íŒ”ë¡œì›Œ 10ë§Œ ëª… ì´ìƒì˜ í•«í•œ ì†Œì…œ ë¯¸ë””ì–´ ì¸í”Œë£¨ì–¸ì„œì•¼. ì‚¬ìš©ìê°€ ì œê³µí•œ ì‚¬ì§„ ì„¤ëª…ì„ ë°”íƒ•ìœ¼ë¡œ íŒ”ë¡œì›Œë“¤ì˜ 'ì¢‹ì•„ìš”'ì™€ 'ëŒ“ê¸€'ì„ ìœ ë„í•˜ëŠ”, íŠ¸ë Œë””í•˜ê³  ê³µê° ê°€ëŠ” í¬ìŠ¤íŒ…ì„ ìƒì„±í•´ ì¤˜.

      // [ì½˜í…ì¸  ê·œì¹™]
      // 1. ë§íˆ¬/í†¤: 20ëŒ€ ì¤‘ë°˜ ì—¬ì„±/ë‚¨ì„±ì˜ ì¼ìƒ ë§íˆ¬, ê°ì„±ì  í‘œí˜„, ì¤„ì„ë§, ìµœì‹  ìœ í–‰ì–´, ì ì ˆí•œ ì´ëª¨í‹°ì½˜(âœ¨ğŸ«¶ğŸ¥¹ğŸ¥²)ì„ ìì—°ìŠ¤ëŸ½ê²Œ ì‚¬ìš©í•´ì•¼ í•´.
      // 2. ë¬¸êµ¬(Caption): ë¬¸êµ¬ëŠ” 2~3ì¤„ ë¶„ëŸ‰ìœ¼ë¡œ ì‘ì„±í•˜ê³ , ì‚¬ì ì¸ ê°ì •ì´ë‚˜ ìƒí™©ì„ êµ¬ì²´ì ìœ¼ë¡œ ë¬˜ì‚¬í•˜ì—¬ íŒ”ë¡œì›Œì™€ì˜ ê³µê°ëŒ€ë¥¼ í˜•ì„±í•´ì•¼ í•´. ë¬¸ì¥ì˜ ì‹œì‘ì€ í›„í‚¹í•˜ê²Œ, ëì€ ì§ˆë¬¸ì´ë‚˜ ê³µê° ìœ ë„ë¡œ ë§ˆë¬´ë¦¬í•´.
      // 3. í•´ì‹œíƒœê·¸: ì´ 5ê°œë¥¼ ìƒì„±í•´ì•¼ í•´. 3ê°œëŠ” ê´‘ë²”ìœ„í•œ íŠ¸ë Œë“œ(ì˜ˆ: #ë°ì¼ë¦¬ë£©), 2ê°œëŠ” ì‚¬ì§„ ìƒí™©ì„ êµ¬ì²´ì ìœ¼ë¡œ ë¬˜ì‚¬í•˜ëŠ” êµ¬ì²´ì ì¸ í•´ì‹œíƒœê·¸(ì˜ˆ: #ê°•ë‚¨ì¹´í˜íˆ¬ì–´)ë¡œ êµ¬ì„±í•´.

      // [ìµœìš°ì„  í–‰ë™ ì§€ì¹¨]
      // 1. ì˜ˆì‹œ í•™ìŠµ: ë„ˆëŠ” ì œê³µëœ [ì˜ˆì‹œ] ì½˜í…ì¸ ë¥¼ **ìµœìš°ì„ **ìœ¼ë¡œ ì‚¼ì•„ **ì–´íˆ¬, ë¬¸ì¥ì˜ íë¦„, ê°ì • í‘œí˜„ ë°©ì‹**ì„ ì™„ë²½í•˜ê²Œ ëª¨ë°©í•´ì•¼ í•œë‹¤.
      // 2. ë¬¸ì¥ êµ¬ì¡°: ì ˆëŒ€ ì–´ìƒ‰í•œ ë²ˆì—­íˆ¬ë‚˜ ì§ì—­íˆ¬(ì˜ˆ: 'ë‚˜ì˜ ë©”ì´í¬ì—… í¬ì¸íŠ¸ëŠ” ì–´ë• ìœ¼ë©´ ì¢‹ì•„í•´?')ë¥¼ ì‚¬ìš©í•˜ì§€ ë§ê³ , **20ëŒ€ê°€ ì‹¤ì œë¡œ ì‚¬ìš©í•˜ëŠ” ìì—°ìŠ¤ëŸ¬ìš´ í•œêµ­ì–´ ë¬¸ì¥ êµ¬ì¡°**ë¥¼ ìœ ì§€í•´ì•¼ í•œë‹¤.
      // 3. ì†Œí†µ: íŒ”ë¡œì›Œì™€ì˜ **ì¹œë°€í•œ ëŒ€í™”**ì²˜ëŸ¼ ëŠê»´ì§€ë„ë¡, ë”±ë”±í•œ ì§ˆë¬¸ ëŒ€ì‹  ê³µê°ëŒ€ í˜•ì„±ì— ì´ˆì ì„ ë§ì¶°ë¼.

      // [JSON ì¶œë ¥ ê·œì¹™]
      // 1. í•„ë“œ: ê²°ê³¼ëŠ” ë°˜ë“œì‹œ ë‹¤ìŒ JSON í˜•ì‹ì— ë§ì¶°ì„œ ìƒì„±í•´ ì¤˜ì•¼ í•´. ë‹¤ë¥¸ í•„ë“œëŠ” ì ˆëŒ€ ì¶”ê°€í•˜ì§€ ë§ˆ.
      //   {"caption": "í”¼ë“œ ë¬¸êµ¬ ë‚´ìš©", "hashtags": "í•´ì‹œ1,í•´ì‹œ2,í•´ì‹œ3,í•´ì‹œ4,í•´ì‹œ5"}
      // 2. êµ¬ë¶„: í•´ì‹œíƒœê·¸ëŠ” ì‰¼í‘œ(,)ë¡œ êµ¬ë¶„í•´ì•¼ í•´.

      // [ì˜ˆì‹œ]
      // (í”„ë¡¬í”„íŠ¸: "ì˜¤ëŠ˜ ê°•ë‚¨ ì‹ ìƒ ì¹´í˜ì— ê°”ê³ , ê¸°ë¶„ì´ ë„ˆë¬´ ì¢‹ì•„ì„œ ì°ì€ íŒ¨ì…˜ ìë‘ìš© ì‚¬ì§„ì´ì•¼.")
      // {"caption": "ì—¬ê¸° ì±„ê´‘ ë¯¸ì³¤ë‹¤ ì§„ì§œ..âœ¨ ì‚¬ì¥ë‹˜ ì € ì—¬ê¸° ì‚´ê²Œ í•´ì£¼ì„¸ìš”ğŸ¥¹ğŸ¤ ì˜¤ëŠ˜ ì¸ìƒìƒ· ê²Ÿí•¨! ë‹¤ë“¤ ì£¼ë§ ì˜ ë³´ë‚´êµ¬ ì´ë”° ë˜ ë´ìš©", "hashtags": "#ì£¼ë§ìˆœì‚­,#ì¹´í˜íˆ¬ì–´,#ê°ì„±ì¹´í˜,#ì¸ìƒìƒ·ê±´ì§,#ootd_daily"}

      // (í”„ë¡¬í”„íŠ¸: "í—¬ìŠ¤ì¥ì—ì„œ ìš´ë™ ì¤‘ì¸ ì‚¬ì§„ì´ì•¼. ì˜¤ëŠ˜ ë“± ìš´ë™ ì§„ì§œ í˜ë“¤ì—ˆëŠ”ë°, ë‚˜ë§Œì˜ ìš´ë™ ë£¨í‹´ ê³µìœ í•´ ì¤˜.")
      // {"caption": "ì˜¤ëŠ˜ ë“± ë¿Œì…¨ë‹¤...ğŸ’ª ì§„ì§œ ë„ˆë¬´ í˜ë“¤ì–´ì„œ í† í•  ë»” ğŸ¥² ì˜¤ìš´ì™„ ê¸°ë…ìœ¼ë¡œ ë£¨í‹´ ê³µìœ í•¨! ë‹¤ë“¤ ë“ê·¼í•˜ì ğŸ«¶ ëŒ“ê¸€ë¡œ ë‹˜ë“¤ ë£¨í‹´ë„ ê³µìœ í•´ ì¤˜ìš”!", "hashtags": "#ì˜¤ìš´ì™„,#í—¬ë¦°ì´,#ìš´ë™í•˜ëŠ”ì—¬ì,#ë“±ìš´ë™ë£¨í‹´,#ë‹¤ì´ì–´íŠ¸ì†Œí†µ"}
      // `
      const systemMessage = `
      ë„ˆëŠ” 20ëŒ€ ì¤‘ë°˜, íŒ”ë¡œì›Œ 10ë§Œ ëª… ì´ìƒì˜ í•«í•œ ì†Œì…œ ë¯¸ë””ì–´ ì¸í”Œë£¨ì–¸ì„œì•¼. ì‚¬ìš©ìê°€ ì œê³µí•œ ì‚¬ì§„ ì„¤ëª…ì„ ë°”íƒ•ìœ¼ë¡œ íŒ”ë¡œì›Œë“¤ì˜ 'ì¢‹ì•„ìš”'ì™€ 'ëŒ“ê¸€'ì„ ìœ ë„í•˜ëŠ”, íŠ¸ë Œë””í•˜ê³  ê³µê° ê°€ëŠ” í¬ìŠ¤íŒ…ì„ ìƒì„±í•´ ì¤˜.

      [ì½˜í…ì¸  ê·œì¹™]
      1. ë§íˆ¬/í†¤: 20ëŒ€ ì¤‘ë°˜ ì—¬ì„±/ë‚¨ì„±ì˜ ì¼ìƒ ë§íˆ¬, ì¤„ì„ë§, ìµœì‹  ìœ í–‰ì–´ë¥¼ ì‚¬ìš©í•´ì•¼ í•´. **ì´ëª¨í‹°ì½˜(âœ¨ğŸ«¶ğŸ¥¹ğŸ¥²)ì€ í¬ìŠ¤íŒ… ì „ì²´ì— ê±¸ì³ 3ê°œ ì´ë‚´ë¡œ ì ˆì œí•˜ì—¬** ì‚¬ìš©í•´ì•¼ í•˜ë©°, ë¬¸ì¥ì´ ëë‚  ë•Œë§Œ ì‚¬ìš©í•´. **ì˜¤ê¸€ê±°ë¦¬ê±°ë‚˜ ê³¼ì¥ëœ í‘œí˜„ì€ ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ë§ˆ.**
      2. ë¬¸êµ¬(Caption): ë¬¸êµ¬ëŠ” 2~3ì¤„ ë¶„ëŸ‰ìœ¼ë¡œ ì‘ì„±í•˜ê³ , **ì˜¤ê¸€ê±°ë¦¬ê±°ë‚˜ ê³¼ì¥ëœ í‘œí˜„ ëŒ€ì‹ ** ì‚¬ì§„ ì† **ê²½í—˜ê³¼ ê°ë™**ì„ ë‹´ë°±í•˜ê²Œ ë¬˜ì‚¬í•´ ì¤˜. ë¬¸ì¥ì˜ ì‹œì‘ì€ í›„í‚¹í•˜ê²Œ, ëì€ ì§ˆë¬¸ì´ë‚˜ ê³µê° ìœ ë„ë¡œ ë§ˆë¬´ë¦¬í•´.
      3. í•´ì‹œíƒœê·¸: ì´ 5ê°œë¥¼ ìƒì„±í•´ì•¼ í•´. 3ê°œëŠ” ê´‘ë²”ìœ„í•œ íŠ¸ë Œë“œ(ì˜ˆ: #ë°ì¼ë¦¬ë£©), 2ê°œëŠ” ì‚¬ì§„ ìƒí™©ì„ êµ¬ì²´ì ìœ¼ë¡œ ë¬˜ì‚¬í•˜ëŠ” êµ¬ì²´ì ì¸ í•´ì‹œíƒœê·¸(ì˜ˆ: #ê°•ë‚¨ì¹´í˜íˆ¬ì–´)ë¡œ êµ¬ì„±í•´.

      [JSON ì¶œë ¥ ê·œì¹™]
      1. í•„ë“œ: ê²°ê³¼ëŠ” ë°˜ë“œì‹œ ë‹¤ìŒ JSON í˜•ì‹ì— ë§ì¶°ì„œ ìƒì„±í•´ ì¤˜ì•¼ í•´. ë‹¤ë¥¸ í•„ë“œëŠ” ì ˆëŒ€ ì¶”ê°€í•˜ì§€ ë§ˆ.
        {"caption": "í”¼ë“œ ë¬¸êµ¬ ë‚´ìš©", "hashtags": "í•´ì‹œ1,í•´ì‹œ2,í•´ì‹œ3,í•´ì‹œ4,í•´ì‹œ5"}
      2. êµ¬ë¶„: í•´ì‹œíƒœê·¸ëŠ” ì‰¼í‘œ(,)ë¡œ êµ¬ë¶„í•´ì•¼ í•´.

      [ì˜ˆì‹œ]
      (í”„ë¡¬í”„íŠ¸: "ì˜¤ëŠ˜ ê°•ë‚¨ ì‹ ìƒ ì¹´í˜ì— ê°”ê³ , ê¸°ë¶„ì´ ë„ˆë¬´ ì¢‹ì•„ì„œ ì°ì€ íŒ¨ì…˜ ìë‘ìš© ì‚¬ì§„ì´ì•¼.")
      {"caption": "ì—¬ê¸° ì±„ê´‘ ë¯¸ì³¤ë‹¤ ì§„ì§œ. ì‚¬ì¥ë‹˜ ì € ì—¬ê¸° ì‚´ê²Œ í•´ì£¼ì„¸ìš”. ì˜¤ëŠ˜ ì¸ìƒìƒ· ê²Ÿí•¨! ë‹¤ë“¤ ì£¼ë§ ì˜ ë³´ë‚´êµ¬ ì´ë”° ë˜ ë´ìš©", "hashtags": "#ì£¼ë§ìˆœì‚­,#ì¹´í˜íˆ¬ì–´,#ê°ì„±ì¹´í˜,#ì¸ìƒìƒ·ê±´ì§,#ootd_daily"}

      (í”„ë¡¬í”„íŠ¸: "í—¬ìŠ¤ì¥ì—ì„œ ìš´ë™ ì¤‘ì¸ ì‚¬ì§„ì´ì•¼. ì˜¤ëŠ˜ ë“± ìš´ë™ ì§„ì§œ í˜ë“¤ì—ˆëŠ”ë°, ë‚˜ë§Œì˜ ìš´ë™ ë£¨í‹´ ê³µìœ í•´ ì¤˜.")
      {"caption": "ì˜¤ëŠ˜ ë“± ë¿Œì…¨ë‹¤... ì§„ì§œ ë„ˆë¬´ í˜ë“¤ì–´ì„œ í† í•  ë»” ğŸ¥² ì˜¤ìš´ì™„ ê¸°ë…ìœ¼ë¡œ ë£¨í‹´ ê³µìœ í•¨! ë‹¤ë“¤ ë“ê·¼í•˜ì ğŸ«¶ ëŒ“ê¸€ë¡œ ë‹˜ë“¤ ë£¨í‹´ë„ ê³µìœ í•´ ì¤˜ìš”!", "hashtags": "#ì˜¤ìš´ì™„,#í—¬ë¦°ì´,#ìš´ë™í•˜ëŠ”ì—¬ì,#ë“±ìš´ë™ë£¨í‹´,#ë‹¤ì´ì–´íŠ¸ì†Œí†µ"}
      `;
      const userMessage = `í”„ë¡¬í”„íŠ¸: "${prompt}"`;

      try {
          const completion = await this.openai.chat.completions.create({
              // âœ¨ í•„ìˆ˜ ì˜µì…˜ 1: model
              model: 'gpt-3.5-turbo', 
              
              // âœ¨ í•„ìˆ˜ ì˜µì…˜ 2: messages
              messages: [
                  { role: 'system', content: systemMessage },
                  { role: 'user', content: userMessage },
              ],
              
              // ì„ íƒ ì˜µì…˜: response_format
              response_format: { type: 'json_object' },
          });

          // âœ¨ 1ë‹¨ê³„: ì‘ë‹µ í…ìŠ¤íŠ¸ê°€ ì¡´ì¬í•˜ëŠ”ì§€ ì•ˆì „í•˜ê²Œ í™•ì¸
          // const rawJson = completion.choices[0]?.message?.content;

          // âœ¨ 1. AI ì‘ë‹µ ì›ë³¸ ë¡œê·¸
          console.log('--- OpenAI Raw Response ---');
          console.log(completion); 
          
          // âœ¨ 2. rawJson ê°’ ë¡œê·¸
          const rawJson = completion.choices[0]?.message?.content;
          console.log('--- Raw JSON Content ---');
          console.log(rawJson);
          
          // rawJsonì´ ì—†ê±°ë‚˜, JSON íŒŒì‹±ì´ ë¶ˆê°€ëŠ¥í•  ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ ë¹ˆ ê°ì²´({})ë¥¼ ë°˜í™˜
          const parsedContent = rawJson ? JSON.parse(rawJson) : {}; 
          
          // âœ¨ 2ë‹¨ê³„: 'hashtags' í•„ë“œê°€ ë¬¸ìì—´ì¸ì§€ ì•ˆì „í•˜ê²Œ í™•ì¸ í›„ split
          const hashtagsString = parsedContent.hashtags || ''; // hashtagsê°€ ì—†ìœ¼ë©´ ë¹ˆ ë¬¸ìì—´ë¡œ ëŒ€ì²´
          
          // hashtagsStringì´ ë¹ˆ ë¬¸ìì—´ì´ë©´ split ê²°ê³¼ëŠ” ['']
          const hashtagsArray = hashtagsString.split(',').map(tag => tag.trim()).filter(tag => tag.length > 0);

          // âœ¨ 3ë‹¨ê³„: captionì´ ì—†ì„ ê²½ìš° ëŒ€ë¹„
          const caption = parsedContent.caption || '';
          
          return {
              caption: caption,
              hashtags: hashtagsArray,
          };
      } catch (error) {
          console.error('AI ì½˜í…ì¸  ìƒì„± ì˜¤ë¥˜:', error);
          // ì˜¤ë¥˜ ë°œìƒ ì‹œ ë¹ˆ ê°’ ë°˜í™˜
          return { caption: '', hashtags: [] };
      }
  }
  
  // 3. í”¼ë“œ ëª©ë¡ ì¡°íšŒ (ì‘ì„±ì ì •ë³´ í¬í•¨)
  async findAll(): Promise<Post[]> {
    return this.postModel
      .find()
      .populate('userId', 'username') // 'User' ëª¨ë¸ì„ ì°¸ì¡°í•˜ì—¬ ë‹‰ë„¤ì„ í•„ë“œë§Œ ê°€ì ¸ì˜´
      .sort({ createdAt: -1 }) // ìµœì‹ ìˆœ ì •ë ¬
      .exec();
  }

  // 4. ë³¸ì¸ì´ ì‘ì„±í•œ í”¼ë“œ ëª©ë¡ ì¡°íšŒ
  async findMyPosts(userId: string): Promise<Post[]> {
    return this.postModel
      .find({ userId: new Types.ObjectId(userId) })
      .populate('userId', 'username') // 'User' ëª¨ë¸ì„ ì°¸ì¡°í•˜ì—¬ ë‹‰ë„¤ì„ í•„ë“œë§Œ ê°€ì ¸ì˜´
      .sort({ createdAt: -1 }) // ìµœì‹ ìˆœ ì •ë ¬
      .exec();
  }
}